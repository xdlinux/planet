<html><head></head><body><p>最近好哥们沉迷pocketchip，但是苦于架构比较古老（ARM-V7a但是能跑Linux Mainline），所以镜像站特别稀少，只有个国外的站点还开着。所以嘛，闲着也是闲着，就打算自己搭建一个镜像站咯。</p><p>顺便还能好好玩玩那个ESXi服务器。毕竟现在就只跑了一个OpenWRT和一个Ubuntu Server，实在没利用起来（</p><p>或许回头整个本地镜像源还能试试刷新一下Arch安装速度记录（逃</p><h2 id="准备"><a href="https://mxts.jiujiuer.xyz/2023/10/16/setup-local-linux-mirror/#%E5%87%86%E5%A4%87" class="headerlink" title="准备"></a>准备</h2><p>首先需要足够的硬盘空间和一个Linux计算机，以及差不多的网络环境。</p><p>然后是一些<del>神秘妙妙</del>工具：<code>apache2, debmirror, gnupg, xz-utils, rsync(recommend)</code></p><h2 id="开始"><a href="https://mxts.jiujiuer.xyz/2023/10/16/setup-local-linux-mirror/#%E5%BC%80%E5%A7%8B" class="headerlink" title="开始"></a>开始</h2><p>首先，因为同步的数据量会比较大，所以建议使用一块单独的硬盘或者看具体情况分个区都行。硬盘处理好后，可以将它挂载到<code>/mount/</code>下，随后创建我们的镜像站仓库目录们。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /mirror/debmirror/{amd64,keyring}</span><br/><span class="line"><span class="built_in">mkdir</span> -p /mirror/scripts        <span class="comment"># 各种镜像站工具脚本</span></span><br/></pre></td></tr></tbody></table></figure><p>随后安装GPG keyrnig：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">gpg --no-default-keyring --keyring /mirror/debmirror/mirrorkeyring/trustedkeys.gpg --import /usr/share/keyrings/ubuntu-archive-keyring.gpg</span><br/></pre></td></tr></tbody></table></figure><p>安装完成后，在Web服务器站点根目录创建符号链接：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/www/html</span><br/><span class="line"><span class="built_in">ln</span> -s /mirror/debmirror/amd64 ubuntu</span><br/></pre></td></tr></tbody></table></figure><p>在这之后，我们还需要配置debmirror才能实现自动同步upstream等功能。</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /mirror/scripts</span><br/><span class="line">wget https://louwrentius.com/files/debmirroramd64.sh.txt -O debmirroramd64.sh </span><br/><span class="line"><span class="built_in">chmod</span> +x debmirroramd64.sh</span><br/></pre></td></tr></tbody></table></figure><p>接着修改脚本设置：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GNUPGHOME=/mirror/debmirror/mirrorkeyring</span><br/><span class="line">release=focal,focal-security,focal-updates,focal-backports,jammy,jammy-security,jammy-updates,jammy-backports</span><br/><span class="line">server=nl.archive.ubuntu.com</span><br/><span class="line">proto=rsync</span><br/><span class="line">outPath=/mirror/debmirror/amd64</span><br/><span class="line"><span class="comment">#bwlimit=1000               # 设置rsync的带宽限速为1000KB/s，如果要启用这个限制，还需要取消注释下面的行：</span></span><br/><span class="line">--rsync-options <span class="string">&#34;-aIL --partial --bwlimit=<span class="variable">$bwlimit</span>&#34;</span> \</span><br/></pre></td></tr></tbody></table></figure><p>完成后，你可以先运行一次脚本来完成第一次同步。<strong>同步完成后</strong>，再在crontab里边加上自动任务（不然你的同步进程时间过长，可能会干扰cron任务）：</p><figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/></pre></td><td class="code"><pre><span class="line">0 1 * * * /mirror/scripts/debmirroramd64.sh</span><br/></pre></td></tr></tbody></table></figure><h2 id="References"><a href="https://mxts.jiujiuer.xyz/2023/10/16/setup-local-linux-mirror/#References" class="headerlink" title="References"></a>References</h2><blockquote><p><a href="https://louwrentius.com/how-to-setup-a-local-or-private-ubuntu-mirror.html">Louwrentius - How to Setup a Local or Private Ubuntu Mirror</a><br/><a href="https://www.debian.org/mirror/ftpmirror">Debian - Setting up a Debian archive mirror</a></p></blockquote></body></html>