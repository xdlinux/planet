<link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" cla<hr /><link rel="stylesheet" class="aplayer-secondary-style-marker" href="\assets\css\APlayer.min.css"><script src="\assets\js\APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>Reference：<a href="http://wu.run/2018/12/20/hexo-from-github-2-aliyun/">http://wu.run/2018/12/20/hexo-from-github-2-aliyun/</a></p></blockquote><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本次迁移，实质是将个人站点部署到阿里云内地节点服务器，以符合阿里云备案要求。</p><img src="/2021/10/22/hexo-from-GithubPages-2-aliyun/image.png" class="" title="阿里云备案核查通知"><p>附：<a href="https://help.aliyun.com/noticelist/articleid/1060895544.html?spm=a2c4g.788314815.n2.6.5f3c4c07Vmay0j">关于阿里云用户ICP备案情况自查的通知</a>，<a href="https://beian.aliyun.com/pcContainer/domainCheck">备案接入准确性检查链接</a></p><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><h2 id="ssh连接"><a href="#ssh连接" class="headerlink" title="ssh连接"></a>ssh连接</h2><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">ssh root@公网IP<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><ul><li>更新package</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">sudo apt updatesudo apt upgrade<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>安装nginx</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">sudo apt-get install nginx <span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>测试安装是否成功</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">nginx -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>nginx相关目录</li></ul><p>&ensp;&ensp;&ensp;&ensp;- <code>/usr/sbin/nginx</code>  — nginx主程序</p><p>&ensp;&ensp;&ensp;&ensp;- <code>/etc/nginx</code> — 存放nginx相关配置</p><p>&ensp;&ensp;&ensp;&ensp;- <code>/var/log/nginx</code> — 存放nginx日志 </p><h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><ul><li>安装并配置本地用户信息</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">sudo apt-get install gitgit config --global user.name &quot;your name&quot;git config --global user.email &quot;your email&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="首次clone，配置环境"><a href="#首次clone，配置环境" class="headerlink" title="首次clone，配置环境"></a>首次clone，配置环境</h2><ul><li>生成本地公钥/私钥，直接三次回车，不推荐设置密码</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">ssh-keygen -t rsa<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><img src="/2021/10/22/hexo-from-GithubPages-2-aliyun/image_1.png" class=""><ul><li>查看并添加ssh key信息到github</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">cat ~&#x2F;.ssh&#x2F;id_rsa.pub<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h1 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h1><ul><li>进入<code>/var/www/html</code>，clone博客源代码</li></ul><img src="/2021/10/22/hexo-from-GithubPages-2-aliyun/image_2.png" class=""><ul><li>修改<code>/etc/nginx/sites-available/default</code>文件中server下的root字段值为clone的博客目录路径</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">server &#123;        listen 80 default_server;        listen [::]:80 default_server;        root &#x2F;var&#x2F;www&#x2F;html&#x2F;forest&#x2F;forest-lee.github.io;        ... #省略，未复制&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>重新运行nginx</li></ul><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">nginx -s reload<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>这时，就可以通过访问阿里云服务器的公网IP查看个人博客（这里个人发生了一点小插曲：修改后访问ip显示404页面，一直以为是配置问题，结果是路径打错了QAQ）</p><h2 id="绑定域名"><a href="#绑定域名" class="headerlink" title="绑定域名"></a>绑定域名</h2><p>使用已购买并备案的域名，解析至阿里云服务器的公网IP。</p><img src="/2021/10/22/hexo-from-GithubPages-2-aliyun/image_3.png" class=""><h1 id="自动同步"><a href="#自动同步" class="headerlink" title="自动同步"></a>自动同步</h1><h2 id="问题提出"><a href="#问题提出" class="headerlink" title="问题提出"></a>问题提出</h2><p>经过上述操作，我们实质是将博客源代码git clone到路径<code>/var/www/html/forest-lee.github.io</code>，如果需要对博客进行修改或发布新文章，运行<code>hexo d</code>还是只能将新源码pull到github及gitee上，而无法自动上传到服务器上。要想同步修改，还是需要在服务器上的博客路径删除源码并重新git clone，非常麻烦。</p><h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><p>解决方法很简单，只需要在阿里云服务器上搭建一个Git远程仓库，每次通过<code>hexo d</code>更新源码时，也同步更新至服务器仓库中，并自动同步到<code>/var/www/html/forest-lee.github.io</code>中。</p><p>具体做法：</p><ol><li>创建git用户</li></ol><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">adduser git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="2"><li>创建git裸仓hexo.git</li></ol><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">cd &#x2F;home&#x2F;gitgit init --bare hexo.git<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ol start="3"><li>修改权限</li></ol><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">chown -R git:git hexo.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ol start="4"><li><p>写入信息</p><p> 获取并复制本地SSH公钥并写入服务器<code>/home/git/.ssh/authorized_keys</code>(没有则创建)文件</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> ~/.ssh/id_rsa.pub<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p> 在<code>/home/git/hexo.git/hooks/post-receive</code>(没有则创建)文件中写入：</p> <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/sh</span><span class="token function">git</span> --work-tree<span class="token operator">=</span>/var/www/html/forest-lee.github.io --git-dir<span class="token operator">=</span>/home/git/hexo.git checkout <span class="token parameter variable">-f</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ol><ol start="5"><li>修改本地_config.yml文件</li></ol><pre class="line-numbers language-Bash" data-language="Bash"><code class="language-Bash">deploy:  type: git  repo:     gitee: https:&#x2F;&#x2F;gitee.com&#x2F;frank-f-lee&#x2F;frank-lee.git # HTTPS    github: git@github.com:Forest-Lee&#x2F;forest-lee.github.io.git # SSH    hexo: root@106.14.97.210:&#x2F;home&#x2F;git&#x2F;hexo.git  brach: master  message: blog<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="小插曲"><a href="#小插曲" class="headerlink" title="小插曲"></a>小插曲</h2><h3 id="域名无法正常访问"><a href="#域名无法正常访问" class="headerlink" title="域名无法正常访问"></a>域名无法正常访问</h3><p>将域名正确解析到公网ip后，发现直接访问域名<code>forestlee.top</code>被拒绝<code>ERR_CONNECTION_CLOSED</code>，而<code>www.forestlee.top</code>可以正常访问；咨询阿里云客服，最终找到原因——<strong>浏览器的缓存导致访问域名时直接添加了https</strong>，而没有进行SSL申请，不能访问https页面。</p><blockquote><p>服务器443端口无法访问，所以https页面无法打开，目前应该是浏览器的缓存使直接访问域名添加了https，这边浏览器没有自动添加https，所以这边可以访问的。您可以清理缓存后直接访问<a href="http://forestlee.top/?spm=5176.smartservice_service_robot-chat.0.0.59b1709acVejCS">http://forestlee.top</a>。</p><p>需要申请过SSL证书，并在服务器上配置了SSL证书后才能通过443端口访问https页面。</p></blockquote><h3 id="伪自动同步"><a href="#伪自动同步" class="headerlink" title="伪自动同步"></a>伪自动同步</h3><p>本人在初次完成以上步骤后，发现<code>hexo d</code>提交时，博客源码并没有自动同步到服务器上。</p><img src="/2021/10/22/hexo-from-GithubPages-2-aliyun/image_4.png" class=""><blockquote><p>其实从上图中的”hint: The ‘hooks/post-receive’ hook was ignored because it’s not set as executable.”就可以略窥一二了。</p></blockquote><p>为此，我尝试了多次（重建服务器git仓库…），最后在和<a href="https://npfs06.top/">npfs</a>的交流中找到了问题所在——**<code>post-receive</code>文件的权限问题**</p><img src="/2021/10/22/hexo-from-GithubPages-2-aliyun/chmod.png" class="" title="更改post-receive权限"><blockquote><p>  由此足见Linux文件权限的重要性，学习指路：<a href="https://www.runoob.com/linux/linux-comm-chmod.html">Linux chmod 命令</a></p></blockquote><p>至此，你已经可以通过<code>hexo d</code>直接将博客源码上传到gitee、github并自动同步到服务器。</p><h2 id="效果展示"><a href="#效果展示" class="headerlink" title="效果展示"></a>效果展示</h2><img src="/2021/10/22/hexo-from-GithubPages-2-aliyun/final.png" class="" title="博客源码上传效果图">