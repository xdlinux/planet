<h1 id="Windows-上用-CapsLock-切换中英文">Windows 上用 CapsLock 切换中英文<a class="headerlink" href="#Windows-上用-CapsLock-切换中英文" title="Permanent link">&para;</a></h1>
<!-- more -->

<p>微软输入法切换中英文的按键选择有 Ctrl、Shift、Ctrl+Space，但它们都是其他软件常用的修饰符/快捷键，肯定没法用。后来，我用一个纯英文键盘布局和一个纯中文键盘布局，靠 Win+Space 切换，但这个快捷键按着也挺麻烦。</p>
<p>受 MacOS 的启发，我决定改用 CapsLock 切换中英文。恰好，我平时切换大小写用的都是 Shift。CapsLock 放在那么好的位置却不用，很可惜。</p>
<h2 id="按键映射">按键映射<a class="headerlink" href="#按键映射" title="Permanent link">&para;</a></h2>
<p>使用 PowerToys 的键盘管理器映射 CapsLock 到 Win+Space。</p>
<h2 id="同步指示灯">同步指示灯<a class="headerlink" href="#同步指示灯" title="Permanent link">&para;</a></h2>
<p>按键都重映射了，指示灯放着不用也怪可惜的。我笔记本键盘上 CapsLock 指示灯就在这个按键右上角，改成中英文指示灯刚好。灯亮时就是中文模式，灯暗时就是英文模式。</p>
<p>代码开源在 GitHub 上：<a href="https://github.com/stalomeow/CapsLockLed-IME">stalomeow/CapsLockLed-IME</a>。特地用纯 C 写的，几乎没有什么开销。大体思路：依靠 <a href="../../../eabe-abdh-cfad/">Windows 全局钩子</a> 监听键盘布局变化（<code>HSHELL_LANGUAGE</code>）事件，然后根据当前布局设置指示灯状态。</p>
<h3 id="检查是否为中文键盘布局">检查是否为中文键盘布局<a class="headerlink" href="#检查是否为中文键盘布局" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">BOOL</span><span class="w"> </span><span class="nf">IsChineseKeyboardLayout</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">CHAR</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">KL_NAMELENGTH</span><span class="p">];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GetKeyboardLayoutNameA</span><span class="p">((</span><span class="n">LPSTR</span><span class="p">)</span><span class="o">&amp;</span><span class="n">name</span><span class="p">))</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// https://learn.microsoft.com/en-us/globalization/keyboards/kbdus_2</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;00000804&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>KeyboardLayoutName 就是 <a href="https://learn.microsoft.com/en-us/windows-hardware/manufacture/desktop/windows-language-pack-default-values?view=windows-11#keyboard-identifiers">Keyboard identifier</a>，简体中文对应的是 <code>"00000804"</code>。</p>
<h3 id="设置指示灯">设置指示灯<a class="headerlink" href="#设置指示灯" title="Permanent link">&para;</a></h3>
<p>需要引入头文件 <a href="https://learn.microsoft.com/en-us/windows/win32/api/ntddkbd/">ntddkbd.h</a>。</p>
<p>具体的思路参考 <a href="https://stackoverflow.com/questions/72679665/is-it-possible-to-control-capslock-light-without-actual-capslocking">windows - Is it possible to control capslock light without actual capslocking? - Stack Overflow</a>。</p><hr />